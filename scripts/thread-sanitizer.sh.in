#!/bin/bash

printUsage()
{
	echo ""
	echo "Usage: $0 input_file output_file <additional tsan options>"
	exit 1
}

if [ "$#" -lt 2 ]
then
	printUsage
fi

# set up environment variables
last=$PWD
cd @ZIPR_LOCATION@
. set_env_vars
export PSPATH=$PSPATH:@PLUGIN_PATH@
export ZIPR_PLUGIN_PATH=$ZIPR_PLUGIN_PATH:@ZIPR_PLUGIN_PATH@
cd $last

# the basic run command without additional tsan options
runCommand="$PSZ $1 $2 -c rida -c move_globals -o --elftables-only -o --no-use-stars --step-option zipr:\"--zipr:seed 42\" -c tsan -o --register-analysis=custom"

file $1 |egrep  "ELF.*shared object" > /dev/null 2>&1 
if [ $? = 0 ]; then
    echo "Detected ELF shared object, not adding libtsan.so dependency"
    runCommand="${runCommand} -o --no-add-libtsan-dependency"
fi

# add tsan options to the run command
i=$(($#-3))
while [ $i -ge 0 ];
do
    runCommand="${runCommand} -o ${BASH_ARGV[$i]}"
    i=$((i-1))
done

# run the binary tsan
eval $runCommand
